#!/usr/bin/env zsh

set -e

BW_SESSION=$(secret-tool lookup session bitwarden)
if test -z "$BW_SESSION" || ! bw unlock --session $BW_SESSION --check; then
	bw unlock --raw | secret-tool store --label='Bitwarden Session Token' session bitwarden
	BW_SESSION=$(secret-tool lookup session bitwarden)
fi

if [ "${1}" = "sync" ]; then
	bw sync
	exit
fi

bw list items --session "${BW_SESSION}" | jq -r '.[] | [.name, .login.password] | @tsv' | fzf --with-nth 1..-2 --layout=reverse --delimiter='\t' | cut -f 2 -d '	' | wl-copy

exit 0
